<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bigo Wallet</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script>
        $(() => {
            var web3Host = 'http://localhost',
                web3Port = '8545';
            var web3 = new Web3();
            web3.setProvider(new web3.providers.HttpProvider(web3Host + ':' + web3Port));
            if (!web3.Connected()) {
                console.error("Ethereum - no conection to RPC server");
            } else {
                console.log("Ethereum - connected to RPC server");
            }


            // Functions
            function getBalance() {
                window.web3.eth.getBalance(window.account, function (err, balance) {
                    console.log(parseFloat(window.web3.fromWei(balance, 'ether')));
                });
            }

            function deployContract() {
                window.currentIPFSHash = null;
                window.currentData = null;

                if (window.contractInstance) {
                    console.error('Contract already deployed. Identifier: ', window.contractAddress);
                    return false;
                }

                window.NotSoSimpleStorageContractObject.new(window.deployContractObject, function (err, contract) {
                    if (err) {
                        console.error('Error deploying contract: ', err);
                    } else if (contract.address) {
                        var contractAddress = contract.address;
                        window.contractAddress = contractAddress;
                        window.contractInstance = window.NotSoSimpleStorageContractObject.at(contractAddress);
                        console.log('Contract deployed at address ', contractAddress);
                    } else if (contract.transactionHash) {
                        console.log("Waiting for contract to be deployed... Contract's transaction hash: ", contract.transactionHash);
                    } else {
                        console.error('Unknown error deploying contract');
                    }
                });
            }

            function sendTransaction(data) {
                if (!window.contractInstance) {
                    console.error('Make sure you deploy your contract first');
                    return;
                }

                if (window.currentData == data) {
                    console.error("Why would you override your contract's data with the same data, you dummy?");
                    return;
                }

                window.contractInstance.set.sendTransaction(data, window.sendDataObject, function (err, result) {
                    if (err) {
                        console.error('Error sending data: ', err);
                    } else {
                        window.currentData = data;
                        console.log('Successfully sent data. Transaction hash: ', result);
                    }
                });
            }

            function getData() {
                if (!window.contractInstance) {
                    console.error('Make sure you deploy your contract first');
                    return;
                }

                window.contractInstance.get.call(function (err, result) {
                    if (err) {
                        console.error('Error getting data: ', err);
                    } else if (result) {
                        if (window.currentIPFSHash == result) {
                            console.log("New data hasn't been mined yet. This is your current data: ", result);
                            return;
                        }

                        window.currentIPFSHash = result
                        var imageURL = window.ipfsDataHost + "/" + result;
                        console.log('File: ', result);
                        console.log(imageURL);
                    } else {
                        console.error('No data. Transaction not mined yet?');
                    }
                });
            }
        });
    </script>
</head>

<body>

</body>

</html>